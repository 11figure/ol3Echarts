<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <title>飞机航线</title>
  <link rel="stylesheet" href="https://unpkg.com/hmap-js@1.5.0/dist/hmap.css">
  <style>
    html, body, #map {
      height: 100%;
      padding: 0;
      margin: 0;
    }
    .hmap-control-zoom {
      right: 30px;
    }
  </style>
</head>
<body>
<div id="map"></div>
<script src="https://unpkg.com/hmap-js@1.5.0/dist/hmap.js"></script>
<script src="https://unpkg.com/jquery@3.2.1/dist/jquery.js"></script>
<script src="https://unpkg.com/echarts@3.7.1/dist/echarts.js"></script>
<script src="https://unpkg.com/ol3-echarts@1.2.0/dist/ol3Echarts.js"></script>
<script>
  $(document).ready(function () {
    var Maps = new HMap('map', {
      controls: {
        loading: true,
        zoomSlider: true,
        fullScreen: false
      },
      view: {
        center: [11464017.313439976, 3934744.6720247352],
        extent: [-2.0037507067161843E7, -3.0240971958386254E7, 2.0037507067161843E7, 3.0240971958386205E7],
        projection: 'EPSG:102100',
        tileSize: 256,
        zoom: 5, // resolution
      },
      baseLayers: [
        {
          layerName: 'vector',
          isDefault: true,
          layerType: 'TileXYZ',
          tileGrid: {
            tileSize: 256,
            extent: [-2.0037507067161843E7, -3.0240971958386254E7, 2.0037507067161843E7, 3.0240971958386205E7],
            origin: [-2.0037508342787E7, 2.0037508342787E7],
            resolutions: [
              156543.03392800014,
              78271.51696399994,
              39135.75848200009,
              19567.87924099992,
              9783.93962049996,
              4891.96981024998,
              2445.98490512499,
              1222.992452562495,
              611.4962262813797,
              305.74811314055756,
              152.87405657041106,
              76.43702828507324,
              38.21851414253662,
              19.10925707126831,
              9.554628535634155,
              4.77731426794937,
              2.388657133974685
            ]
          },
          layerUrl: 'http://cache1.arcgisonline.cn/arcgis/rest/services/ChinaOnlineStreetPurplishBlue/MapServer/tile/{z}/{y}/{x}'
        }
      ]
    });
    $.get('data/flights.json', function(data) {
      function getAirportCoord(idx) {
        return [data.airports[idx][3], data.airports[idx][4]];
      }
      var routes = data.routes.map(function (airline) {
        return [
          getAirportCoord(airline[1]),
          getAirportCoord(airline[2])
        ];
      });
      var option = {
        title: {
          text: '航线',
          left: 'center',
          textStyle: {
            color: '#eee'
          }
        },
        backgroundColor: 'transparent',
        tooltip: {
          formatter: function (param) {
            var route = data.routes[param.dataIndex];
            return data.airports[route[1]][1] + ' > ' + data.airports[route[2]][1];
          }
        },
        openlayers: {},
        series: [{
          type: 'lines',
          coordinateSystem: 'openlayers',
          data: routes,
          large: true,
          largeThreshold: 100,
          lineStyle: {
            normal: {
              opacity: 0.05,
              width: 0.5,
              curveness: 0.3
            }
          },
          // 设置混合模式为叠加
          blendMode: 'lighter'
        }]
      }
      Maps.map.once('postrender', function (e) {
        if (echartslayer !== undefined)
          return;
        var echartslayer = new ol3Echarts(Maps.map, {
          target: '.ol-overlaycontainer',
          source: '',
          destination: ''
        });
        echartslayer.chart.setOption(option);
      });
    })
  });
</script>
</body>
</html>
